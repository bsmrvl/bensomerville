function PTtakeover(e){e.currentTarget.dispatchEvent(myplaythrough)}function alreadyIn(e){for(let t=0;t<Q.length;t++)if(e===Q[t].tid)return t;return-1}function playNew(e,t){var n=e||playlist[playhead],a=playlist[playhead+1]||"sorentino";pauser(),alreadyIn(n)>-1?(up=alreadyIn(n),3==Q[up].state&&(Q[up].a.currentTime=0)):(up=alreadyIn(a)>-1?+!alreadyIn(a):0,Q[up].state<3&&Q[up].abort(null,!1),Q[up].init(n),console.log(n)),alreadyIn(a)<0?(Q[+!up].state<3&&Q[+!up].abort(null,!1),Q[+!up].init(a)):3==Q[+!up].state&&(Q[+!up].a.currentTime=0),showTrack(Q[up].tid),t&&player()}function prev(e){if(e.cancelable&&e.preventDefault(),Q[up].a.currentTime>3)Q[up].a.currentTime=0;else if(playhead>0){var t=pauser();up=+!up,Q[+!up].a.currentTime=0,playhead-=1;var n=playlist[playhead];Q[up].state<3&&Q[up].abort(null,!1),Q[up].init(n),showTrack(Q[up].tid),t&&player()}}function next(e,t){if(e.cancelable&&e.preventDefault(),playhead<playlist.length-1){var n,a=t||pauser();up=+!up,playhead+=1,Q[+!up].state<3&&(Q[+!up].a.dispatchEvent(myplaythrough),Q[+!up].abort(null,!1)),(n=playlist[playhead+1])&&Q[+!up].init(n),showTrack(Q[up].tid),a&&player()}}function playtoggle(){Q[up].a.paused?player():pauser()}function player(){Q[up].a.play()}function pauser(){return!Q[up].a.paused&&(Q[up].a.pause(),!0)}function showTrack(e){var t=tracks.find(t=>t.songid===e);pCover.setAttribute("src","/"+t.coverPath),pCover.parentNode.setAttribute("href","/p/album/"+t.albumid),pName.innerHTML=t.songname,pName.setAttribute("href","/p/song-/"+t.songid),pAlbum.innerHTML=t.album,pAlbum.setAttribute("href","/p/album/"+t.albumid),tracklength.innerHTML=t.runtime,t.spotify?(pSpot.setAttribute("href",t.spotify),pSpot.style.display="block"):pSpot.style.display="none",t.youtube?(pYou.setAttribute("href",t.youtube),pYou.style.display="block"):pYou.style.display="none",t.soundcloud?(pSC.setAttribute("href",t.soundcloud),pSC.style.display="block"):pSC.style.display="none"}function scrubber(e){function t(e){e.cancelable&&e.preventDefault(),i=e.clientX+s,i<r?(scrubPosition(0),a=0):i>r+o?(scrubPosition(o),a=l):(scrubPosition(i-r),a=(i-r)/o*l),tracktime.innerHTML=minSec(a)}function n(){document.removeEventListener("pointermove",t),Q[up].a.currentTime=a,u&&Q[up].a.play(),scrubbing=!1}e.cancelable&&e.preventDefault(),scrubbing=!0;var a,i,r=seekbar.offsetLeft+document.getElementById("player").offsetLeft,s=scrubvis.offsetLeft+r-e.clientX,l=Q[up].a.duration-.01,o=seekbar.offsetWidth-10,u=!Q[up].a.paused;pauser(),document.addEventListener("pointermove",t),document.addEventListener("pointerup",n,{once:!0})}function seekUpdate(){scrubbing||(scrubPosition(Q[up].a.currentTime/Q[up].a.duration*(seekbar.offsetWidth-10)),tracktime.innerHTML=minSec(Q[up].a.currentTime))}function scrubPosition(e){scrub.style.left=e-15+"px",scrubvis.style.left=e+"px"}function minSec(e){var t=Math.floor(e/60).toString(),n=Math.floor(e%60).toString();return 1===n.length&&(n="0"+n),t+":"+n}function fillTrackRow(e,t,n){t.setAttribute("name",n.songid),t.setAttribute("class","player");var a=document.createElement("td");a.innerHTML=e+1;var i=document.createElement("td");i.innerHTML=n.songname;var r=document.createElement("td");r.innerHTML=n.runtime;var s=document.createElement("td");if(t.appendChild(a),t.appendChild(i),t.appendChild(r),t.appendChild(s),"n"===n.instrumental){var l=document.createElement("a");l.innerHTML="Lyrics",l.setAttribute("class","internal"),l.setAttribute("href","/p/song-/"+n.songid),s.appendChild(l)}}function trackList(e){var t=document.getElementsByClassName("tracklist")[0];for(let i=0;i<e.length;i++){var n=tracks.find(t=>t.songid===e[i]),a=document.createElement("tr");t.appendChild(a),fillTrackRow(i,a,n)}var i=document.querySelectorAll("tr a");for(let e=0;e<i.length;e++)i[e].addEventListener("click",e=>e.stopPropagation())}function newShuffle(e=!1){var t=[];for(let e=0;e<10;e++){var n=!1,a=Math.floor(Math.random()*tracks.length);e:for(let e=0;e<t.length;e++)if(tracks[a].songid===t[e]){n=!0;break e}n||t.push(tracks[a].songid)}playlist=t.concat(),playhead=0,playNew(null,e)}function share(){var e=tracks.find(e=>e.songid===playlist[playhead]).albumid,t=document.createElement("input");document.getElementById("footer").appendChild(t),t.value="https://bensomerville.com/p/album/"+e+"#"+playlist[playhead],t.select(),document.execCommand("copy"),t.remove(),copied.style.display="block",setTimeout(()=>{copied.style.display="none"},2e3)}function showLoading(e){e?(tracktime.style.display="none",aLoading.style.display="block"):(aLoading.style.display="none",tracktime.style.display="block")}function playOrPause(e){e?(playb.style.display="none",pauseb.style.display="inline"):(pauseb.style.display="none",playb.style.display="inline")}var playlist,playhead=0,up=0,scrubbing=!1,seekbar=document.getElementById("seekbar"),tracktime=document.getElementById("tracktime"),aLoading=document.getElementById("aLoading"),pCover=document.getElementById("pCover"),pName=document.getElementById("pName"),pAlbum=document.getElementById("pAlbum"),tracklength=document.getElementById("tracklength"),pSpot=document.getElementById("pSpot"),pYou=document.getElementById("pYou"),pSC=document.getElementById("pSC"),playb=document.getElementById("playb"),pauseb=document.getElementById("pauseb"),scrub=document.getElementById("scrub"),scrubvis=document.getElementById("scrubvis"),sharesong=document.getElementById("sharesong");document.getElementById("stickyB").style.visibility="visible";class Slot{constructor(e){this.row=e,this.a=new Audio,this.state=0,this.tid="sorentino",this.ref={li:null,lo:null,fin:null,ab:null}}init(e){this.tid=e;var t=this.abort.bind(this);this.ref.ab=t;var n=this.lineUp.bind(this);this.ref.li=n,document.addEventListener("newimage",t,{once:!0}),fullReady?n():(document.addEventListener("readyforaudio",n,{once:!0}),this.state=0,console.log(this.row+": state 0"))}lineUp(){var e=this.startLoad.bind(this);this.ref.lo=e,this.row==up||3==Q[+!this.row].state?e():(Q[+!this.row].a.addEventListener("myplaythrough",e,{once:!0}),this.state=1,console.log(this.row+": state 1"))}startLoad(){var e=this.loadFin.bind(this);this.ref.fin=e;let t=tracks.find(e=>e.songid===this.tid);this.a.setAttribute("src","/"+t.filePath),console.log(this.row,this.a),this.a.load(),this.a.addEventListener("myplaythrough",e,{once:!0}),this.row==up&&showLoading(!0),this.state=2,console.log(this.row+": state 2")}loadFin(){var e=this.ref.ab;document.removeEventListener("newimage",e),this.row==up&&showLoading(!1),this.state=3,console.log(this.row+": state 3")}abort(e,t=!0){console.log(this.row+": aborting");var n=this.ref.li;document.removeEventListener("readyforaudio",n);var a=this.ref.lo;Q[+!this.row].a.removeEventListener("myplaythrough",a);var i=this.ref.fin;this.a.removeEventListener("myplaythrough",i);var r=this.ref.ab;document.removeEventListener("newimage",r),this.a.setAttribute("src",""),t&&this.init(this.tid)}}var Q=[new Slot(0),new Slot(1)],myplaythrough=new CustomEvent("myplaythrough");Q[0].a.addEventListener("canplaythrough",PTtakeover),Q[1].a.addEventListener("canplaythrough",PTtakeover);var copied=document.getElementById("copied");for(let e=0;e<Q.length;e++)Q[e].a.addEventListener("play",()=>playOrPause(!0)),Q[e].a.addEventListener("pause",()=>playOrPause(!1)),Q[e].a.addEventListener("ended",e=>next(e,!0));document.getElementById("prev").addEventListener("click",prev),document.getElementById("next").addEventListener("click",next),document.getElementById("playpause").addEventListener("click",playtoggle),scrub.addEventListener("pointerdown",scrubber),sharesong.addEventListener("click",share),setInterval(seekUpdate,200);